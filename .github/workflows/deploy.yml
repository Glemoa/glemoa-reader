# GitHub Actions 워크플로우의 이름을 지정합니다.
name: Deploy to Server

# 워크플로우가 트리거될 이벤트를 지정합니다.
on:
  push:
    branches:
      - main # main 브랜치에 푸시될 때 실행됩니다.

jobs:
  # Build 작업: 코드를 빌드하고 배포 파일을 준비합니다.
  build:
    runs-on: ubuntu-latest
    steps:
      # 1. 소스 코드 체크아웃
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. JDK 21 설치
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3. gradlew 실행 권한 부여
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # 4. Gradle로 빌드
      - name: Build with Gradle
        run: ./gradlew build --no-daemon

      # 5. 빌드 결과물(JAR)을 아티팩트로 업로드
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: build/libs/*.jar # 수정된 경로

  # Deploy 작업: 빌드된 파일을 서버에 배포하고 실행합니다.
  deploy:
    needs: build # build 작업이 성공해야 실행됩니다.
    runs-on: ubuntu-latest

    steps:
      # 1. 아티팩트 다운로드
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: app-jar

      # 2. JAR 파일을 서버로 전송 (SCP)
      - name: Transfer JAR to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "*.jar"
          target: "/root/" # 서버의 배포 디렉토리

      # 3. 서버에서 배포 스크립트 실행 (SSH)
      - name: Execute deployment script on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 10m
          script: |
            cd /root
            # JAR 파일 이름을 변수로 지정
            JAR_NAME="glemoa-reader.jar"
            
            # 기존에 실행 중인 애플리케이션 종료
            pkill -f "$JAR_NAME" || true
            sleep 10
            
            # 새 버전의 애플리케이션 실행
            nohup java -jar \
              -Dspring.profiles.active=prod \
              -Dspring.datasource.url=jdbc:mysql://${{ secrets.SERVER_HOST }}:3306/Glemoa \
              -Dspring.datasource.username=${{ secrets.DB_USERNAME }} \
              -Dspring.datasource.password=${{ secrets.DB_PASSWORD }} \
              "$JAR_NAME" > app.log 2>&1 & disown
              
            echo "Deployment script executed for $JAR_NAME"
